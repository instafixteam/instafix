name: Build Pipeline

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # --------------------------
      # Setup Node
      # --------------------------
      - name: Setup Node JS
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # --------------------------
      # INSTALL & BUILD BACKEND
      # --------------------------
      - name: Install Backend Dependencies
        run: |
          cd firebase/backend
          npm install

      - name: Build Backend
        run: |
          cd firebase/backend
          npm run build || echo "Backend build script not defined â€“ skipping."

      # --------------------------
      # INSTALL & BUILD FRONTEND
      # --------------------------
      - name: Install Frontend Dependencies
        run: |
          cd firebase/frontend
          npm install

      - name: Build Frontend
        run: |
          cd firebase/frontend
          npm run build

      # --------------------------
      # UPLOAD BUILD ARTIFACTS
      # --------------------------
      - name: Upload Frontend Build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: firebase/frontend/dist/

      - name: Upload Backend Build
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: firebase/backend/dist/
          if-no-files-found: ignore

      # --------------------------
      # OPTIONAL: BUILD DOCKER IMAGES
      # --------------------------
      - name: Docker Login
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Backend Docker Image
        run: |
          docker build -t ghcr.io/${{ github.repository }}/backend:${{ github.sha }} firebase/backend

      - name: Build Frontend Docker Image
        run: |
          docker build -t ghcr.io/${{ github.repository }}/frontend:${{ github.sha }} firebase/frontend

      # --------------------------
      # TRIVY SCAN DOCKER IMAGES
      # --------------------------
      - name: Scan Backend Image
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ghcr.io/${{ github.repository }}/backend:${{ github.sha }}
          severity: HIGH,CRITICAL

      - name: Scan Frontend Image
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ghcr.io/${{ github.repository }}/frontend:${{ github.sha }}
          severity: HIGH,CRITICAL
      
      # --------------------------
      # SBOM GENERATION (Syft)
      # --------------------------
      # Syft creates a Software Bill of Materials for the container image.
      # This lists all dependencies inside the image (npm packages, OS libraries, etc.)
      # SBOM is required for supply-chain security and future CVE tracking.
      # We generate one SBOM for backend and one for frontend.

      - name: Generate Backend SBOM (Syft)
        uses: anchore/syft-action@v0.11.0
        with:
          image: ghcr.io/${{ github.repository }}/backend:${{ github.sha }}
          output: sbom-backend.spdx.json

      - name: Upload Backend SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-backend
          path: sbom-backend.spdx.json

      - name: Generate Frontend SBOM (Syft)
        uses: anchore/syft-action@v0.11.0
        with:
          image: ghcr.io/${{ github.repository }}/frontend:${{ github.sha }}
          output: sbom-frontend.spdx.json

      - name: Upload Frontend SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-frontend
          path: sbom-frontend.spdx.json


      # --------------------------
      # PUSH DOCKER IMAGES
      # --------------------------
      - name: Push Backend Image
        run: docker push ghcr.io/${{ github.repository }}/backend:${{ github.sha }}

      - name: Push Frontend Image
        run: docker push ghcr.io/${{ github.repository }}/frontend:${{ github.sha }}
