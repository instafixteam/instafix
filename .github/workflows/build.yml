name: Build Pipeline

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # --------------------------
      # Setup Node
      # --------------------------
      - name: Setup Node JS
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # --------------------------
      # INSTALL & BUILD BACKEND
      # --------------------------
      - name: Install Backend Dependencies
        run: |
          cd firebase/backend
          npm install

      - name: Build Backend
        run: |
          cd firebase/backend
          npm run build || echo "Backend build script not defined â€“ skipping."

      # --------------------------
      # INSTALL & BUILD FRONTEND
      # --------------------------
      - name: Install Frontend Dependencies
        run: |
          cd firebase/frontend
          npm install

      - name: Build Frontend
        run: |
          cd firebase/frontend
          npm run build

      # --------------------------
      # UPLOAD BUILD ARTIFACTS
      # --------------------------
      - name: Upload Frontend Build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: firebase/frontend/dist/

      - name: Upload Backend Build
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: firebase/backend/dist/
          if-no-files-found: ignore

      # --------------------------
      # DOCKER HUB LOGIN
      # --------------------------
      - name: Docker Hub Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      # --------------------------
      # BUILD IMAGES
      # --------------------------
      - name: Build Backend Docker Image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/instafix-backend:${{ github.sha }} firebase/backend
      
      - name: Build Frontend Docker Image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/instafix-frontend:${{ github.sha }} firebase/frontend
      
      # --------------------------
      # PUSH IMAGES TO DOCKER HUB
      # --------------------------
      - name: Push Backend Image
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/instafix-backend:${{ github.sha }}
      
      - name: Push Frontend Image
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/instafix-frontend:${{ github.sha }}

      # --------------------------
      # GENERATE SBOMs (SYFT)
      # --------------------------
      - name: Generate SBOM for Backend Image
        uses: anchore/syft-action@v0.1.0
        with:
          image: ${{ secrets.DOCKERHUB_USERNAME }}/instafix-backend:${{ github.sha }}
          output-file: sbom-backend-${{ github.sha }}.json
          format: cyclonedx-json

      - name: Upload Backend SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-backend
          path: sbom-backend-${{ github.sha }}.json

      - name: Generate SBOM for Frontend Image
        uses: anchore/syft-action@v0.1.0
        with:
          image: ${{ secrets.DOCKERHUB_USERNAME }}/instafix-frontend:${{ github.sha }}
          output-file: sbom-frontend-${{ github.sha }}.json
          format: cyclonedx-json

      - name: Upload Frontend SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-frontend
          path: sbom-frontend-${{ github.sha }}.json
          
      # --------------------------
      # TRIVY SCAN DOCKER IMAGES
      # --------------------------
      
      - name: Scan Backend Image
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/instafix-backend:${{ github.sha }}
          severity: HIGH,CRITICAL

      - name: Scan Frontend Image
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/instafix-frontend:${{ github.sha }}
          severity: HIGH,CRITICAL
            
